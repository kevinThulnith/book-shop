<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pahana Edu - Edit Order</title>
    <link rel="icon" th:href="@{/images/logo.png}" type="image/png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                900: "#1e3a8a",
              },
            },
          },
        },
      };
    </script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-900 min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700 shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center">
            <i class="fas fa-edit text-blue-400 text-xl mr-2"></i>
            <span class="text-white font-semibold text-lg"
              >Edit Order #<span th:text="${order.billNumber}"></span
            ></span>
          </div>
          <div class="flex items-center space-x-4">
            <span class="text-gray-300"
              >Welcome,
              <span class="text-white font-medium" th:text="${user.name}"></span
            ></span>
            <a
              th:href="@{/orders}"
              class="text-gray-300 hover:text-white transition duration-200"
            >
              Back to Orders
            </a>
            <a
              th:href="@{/logout}"
              class="text-gray-300 hover:text-white transition duration-200 flex items-center"
            >
              Logout
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
      <!-- Success/Error Messages -->
      <div
        th:if="${successMessage}"
        class="mb-6 bg-green-600 text-white p-4 rounded-lg"
      >
        <span th:text="${successMessage}"></span>
      </div>
      <div
        th:if="${errorMessage}"
        class="mb-6 bg-red-600 text-white p-4 rounded-lg"
      >
        <span th:text="${errorMessage}"></span>
      </div>

      <!-- Order Header -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-start">
          <div>
            <h1 class="text-2xl font-bold text-white">
              Order #<span th:text="${order.billNumber}"></span>
            </h1>
            <div class="text-gray-400 mt-2">
              <p>
                <strong>Customer:</strong>
                <span th:text="${order.customer.name}"></span>
              </p>
              <p>
                <strong>Email:</strong>
                <span th:text="${order.customer.email}"></span>
              </p>
              <p>
                <strong>Phone:</strong>
                <span th:text="${order.customer.telephone}"></span>
              </p>
              <p>
                <strong>Address:</strong>
                <span th:text="${order.customer.address}"></span>
              </p>
              <p>
                <strong>Created:</strong>
                <span
                  th:text="${#temporals.format(order.createdAt, 'MMM dd, yyyy HH:mm')}"
                ></span>
              </p>
            </div>
          </div>
          <div class="text-right">
            <span
              th:class="${order.status.name() == 'DRAFT'} ? 'px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800' : 
                       (${order.status.name() == 'CONFIRMED'} ? 'px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800' : 
                       (${order.status.name() == 'PAID'} ? 'px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800' : 
                       'px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800'))"
              th:text="${order.status}"
            >
            </span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Order Items -->
        <div class="lg:col-span-2">
          <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Order Items</h2>

            <!-- Current Items -->
            <div class="space-y-4 mb-6">
              <div
                th:each="billItem : ${order.billItems}"
                class="bg-gray-700 p-4 rounded-lg"
              >
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h4
                      class="font-medium text-white"
                      th:text="${billItem.item.name}"
                    ></h4>
                    <p
                      class="text-sm text-gray-400"
                      th:text="${billItem.item.description}"
                    ></p>
                    <p class="text-sm text-gray-400">
                      Unit Price: $<span
                        th:text="${#numbers.formatDecimal(billItem.unitPrice, 1, 2)}"
                      ></span>
                    </p>
                    <p class="text-sm text-gray-400">
                      Available Stock:
                      <span th:text="${billItem.item.stockQuantity}"></span>
                    </p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <!-- Quantity Update Form -->
                    <form
                      th:action="@{/orders/{orderId}/update-item/{billItemId}(orderId=${order.billNumber}, billItemId=${billItem.id})}"
                      method="post"
                      class="flex items-center space-x-2"
                    >
                      <label class="text-sm text-gray-300">Qty:</label>
                      <input
                        type="number"
                        name="quantity"
                        th:value="${billItem.quantity}"
                        min="1"
                        th:max="${billItem.item.stockQuantity + billItem.quantity}"
                        class="w-16 px-2 py-1 bg-gray-600 border border-gray-500 rounded text-white text-sm"
                        required
                      />
                      <button
                        type="submit"
                        class="text-blue-400 hover:text-blue-300 text-sm"
                      >
                        <i class="fas fa-check"></i>
                      </button>
                    </form>
                    <!-- Remove Item Form -->
                    <form
                      th:action="@{/orders/{orderId}/remove-item/{billItemId}(orderId=${order.billNumber}, billItemId=${billItem.id})}"
                      method="post"
                      class="inline"
                    >
                      <button
                        type="submit"
                        class="text-red-400 hover:text-red-300"
                        onclick="return confirm('Are you sure you want to remove this item?')"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </div>
                <div class="mt-2 text-right">
                  <span class="text-lg font-semibold text-white">
                    Total: $<span
                      th:text="${#numbers.formatDecimal(billItem.totalPrice, 1, 2)}"
                    ></span>
                  </span>
                </div>
              </div>

              <div
                th:if="${#lists.isEmpty(order.billItems)}"
                class="text-center text-gray-500 py-8"
              >
                <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                <div class="text-lg">No items in this order</div>
                <div class="text-sm">Add items below to get started</div>
              </div>
            </div>

            <!-- Add New Item -->
            <div class="border-t border-gray-600 pt-6">
              <h3 class="text-lg font-medium text-white mb-4">
                Add Item to Order
              </h3>
              <form
                th:action="@{/orders/{orderId}/add-item(orderId=${order.billNumber})}"
                method="post"
                class="space-y-4"
              >
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="md:col-span-2">
                    <label
                      for="itemId"
                      class="block text-sm font-medium text-gray-300 mb-2"
                    >
                      Select Item
                    </label>
                    <select
                      id="itemId"
                      name="itemId"
                      required
                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    >
                      <option value="">Choose an item...</option>
                      <option
                        th:each="item : ${availableItems}"
                        th:value="${item.itemCode}"
                        th:data-price="${item.price}"
                        th:data-stock="${item.stockQuantity}"
                      >
                        <span
                          th:text="${item.name + ' - $' + #numbers.formatDecimal(item.price, 1, 2) + ' (Stock: ' + item.stockQuantity + ')'}"
                        ></span>
                      </option>
                    </select>
                  </div>
                  <div>
                    <label
                      for="quantity"
                      class="block text-sm font-medium text-gray-300 mb-2"
                    >
                      Quantity
                    </label>
                    <input
                      type="number"
                      id="quantity"
                      name="quantity"
                      min="1"
                      value="1"
                      required
                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    />
                  </div>
                </div>
                <div
                  id="itemInfo"
                  class="hidden bg-gray-700 p-3 rounded-lg text-sm text-gray-300"
                >
                  <!-- Item info will be populated by JavaScript -->
                </div>
                <button
                  type="submit"
                  class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition duration-200 flex items-center justify-center"
                >
                  <i class="fas fa-plus mr-2"></i>
                  Add Item
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div>
          <div class="bg-gray-800 rounded-lg shadow-lg p-6 sticky top-8">
            <h2 class="text-xl font-semibold text-white mb-4">Order Summary</h2>

            <div class="space-y-3 text-gray-300">
              <div class="flex justify-between">
                <span>Subtotal:</span>
                <span
                  >$<span
                    th:text="${#numbers.formatDecimal(order.totalAmount ?: 0, 1, 2)}"
                  ></span
                ></span>
              </div>
              <div class="flex justify-between">
                <span>Tax (10%):</span>
                <span
                  >$<span
                    th:text="${#numbers.formatDecimal(order.taxAmount ?: 0, 1, 2)}"
                  ></span
                ></span>
              </div>
              <div class="flex justify-between">
                <span>Discount:</span>
                <span
                  >-$<span
                    th:text="${#numbers.formatDecimal(order.discountAmount ?: 0, 1, 2)}"
                  ></span
                ></span>
              </div>
              <hr class="border-gray-600" />
              <div
                class="flex justify-between text-lg font-semibold text-white"
              >
                <span>Total:</span>
                <span
                  >$<span
                    th:text="${#numbers.formatDecimal(order.finalAmount ?: 0, 1, 2)}"
                  ></span
                ></span>
              </div>
            </div>

            <!-- Order Actions -->
            <div class="mt-6 space-y-3">
              <form
                th:action="@{/orders/{orderId}/confirm(orderId=${order.billNumber})}"
                method="post"
              >
                <button
                  type="submit"
                  th:if="${order.status.name() == 'DRAFT'}"
                  class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition duration-200 flex items-center justify-center"
                  onclick="return confirm('Are you sure you want to confirm this order? Stock quantities will be reduced and the order cannot be modified after confirmation.')"
                >
                  <i class="fas fa-check mr-2"></i>
                  Confirm Order
                </button>
              </form>

              <a
                th:href="@{/orders/{id}(id=${order.billNumber})}"
                class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition duration-200 flex items-center justify-center"
              >
                <i class="fas fa-eye mr-2"></i>
                View Details
              </a>
            </div>

            <!-- Order Status Info -->
            <div class="mt-6 text-sm text-gray-400">
              <div
                th:if="${order.status.name() == 'DRAFT'}"
                class="bg-yellow-900 bg-opacity-50 p-3 rounded-lg"
              >
                <i class="fas fa-info-circle mr-2"></i>
                This order is in draft status. You can add/remove items and
                modify quantities.
              </div>
              <div
                th:if="${order.status.name() == 'CONFIRMED'}"
                class="bg-green-900 bg-opacity-50 p-3 rounded-lg"
              >
                <i class="fas fa-check-circle mr-2"></i>
                This order has been confirmed. Stock quantities have been
                reduced.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Item selection handler
      document.getElementById("itemId").addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const itemInfo = document.getElementById("itemInfo");
        const quantityInput = document.getElementById("quantity");

        if (this.value) {
          const price = selectedOption.getAttribute("data-price");
          const stock = selectedOption.getAttribute("data-stock");

          itemInfo.classList.remove("hidden");
          itemInfo.innerHTML = `
            <div><strong>Price:</strong> $${parseFloat(price).toFixed(2)}</div>
            <div><strong>Available Stock:</strong> ${stock}</div>
          `;

          quantityInput.max = stock;
        } else {
          itemInfo.classList.add("hidden");
          quantityInput.max = "";
        }
      });

      // Quantity validation
      document
        .getElementById("quantity")
        .addEventListener("input", function () {
          const max = parseInt(this.max);
          const value = parseInt(this.value);

          if (max && value > max) {
            this.value = max;
          }
        });
    </script>
  </body>
</html>
